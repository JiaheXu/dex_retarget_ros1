import pickle
from pathlib import Path

import cv2
import tqdm
import tyro


from dex_retargeting.constants import RobotName, RetargetingType, HandType, get_config_path
from dex_retargeting.retargeting_config import RetargetingConfig
from dex_retargeting.seq_retarget import SeqRetargeting
from single_hand_detector import SingleHandDetector

import message_filters
from sensor_msgs.msg import Image, CameraInfo
from std_msgs.msg import String
from typing import Dict, Tuple
import rospy
from sensor_msgs.msg import Image
from cv_bridge import CvBridge
import numpy as np
bridge = CvBridge()
import time
from std_msgs.msg import Float32MultiArray
class retarget():
    
    def __init__(self, retargeting: SeqRetargeting, video_path: str, output_path: str, config_path: str):
        self.retargeting = retargeting
        self.output_path = output_path
        self.config_path = config_path

        self.count = 0
        self.test_pos = [
#  outward                 right                  up
# [[ 0.00000000e+00,  0.00000000e+00,  0.00000000e+00],
#  [ 5.92323764e-03,  2.15578795e-02,  3.35678213e-02],
#  [ 1.86949748e-02,  3.12734596e-02,  5.97782099e-02],
#  [ 3.08022612e-02,  2.98031242e-02,  8.94683560e-02],
#  [ 3.86404147e-02,  2.62039160e-02,  1.15298940e-01], ########## TH tip
#  [-8.43299064e-18,  1.60713207e-02,  9.37611517e-02],
#  [-9.37938365e-04,  1.79327659e-02,  1.24049356e-01],
#  [-5.24854775e-03,  1.66943363e-02,  1.46051403e-01],
#  [ 6.71451175e-03,  5.94698594e-03,  1.69964091e-01], ########### FF tip
#  [-7.24441725e-18,  7.26351127e-18,  8.64563969e-02],
#  [-3.57711501e-03,  1.17781309e-03,  1.26359816e-01],
#  [-3.72205727e-03, -6.71520140e-03,  1.53241475e-01],
#  [ 2.67915170e-03, -1.28882510e-02,  1.83932450e-01], ########### MF tip
#  [ 1.09969881e-02, -1.42899532e-02,  8.20054540e-02],
#  [-4.14662443e-05, -1.75754299e-02,  1.10044929e-01],
#  [-8.66059917e-04, -2.09935762e-02,  1.37455233e-01],
#  [-1.86921862e-03, -2.06870721e-02,  1.65187556e-01], ########### RF tip
#  [ 1.89917087e-02, -3.09123812e-02,  6.56397850e-02],
#  [ 9.57255058e-03, -3.28743632e-02,  8.73346018e-02],
#  [ 6.72530476e-03, -3.56170190e-02,  1.13019986e-01],
#  [ 8.25785921e-03, -3.73950511e-02,  1.30029507e-01]], # PLANE PALM

#point 5 9 13
#  [-8.43299064e-18,  1.60713207e-02,  9.37611517e-02],
#  [-7.24441725e-18,  7.26351127e-18,  8.64563969e-02],
#  [ 1.09969881e-02, -1.42899532e-02,  8.20054540e-02],

# idx 0
#  outward                 right                  up
[[ 0.00000000e+00,  0.00000000e+00,  0.00000000e+00],
 [ 5.92323764e-03,  2.15578795e-02,  3.35678213e-02],
 [ 1.86949748e-02,  3.12734596e-02,  5.97782099e-02],
 [ 3.08022612e-02,  2.98031242e-02,  8.94683560e-02],
 [ 0.86404147e-02,  2.62039160e-02,  1.15298940e-01], ########## TH tip // 3D position estimation not correct
 [-8.43299064e-18,  1.60713207e-02,  9.37611517e-02],
 [-9.37938365e-04,  1.79327659e-02,  1.24049356e-01],
 [-5.24854775e-03,  1.66943363e-02,  1.46051403e-01],
 [ 6.71451175e-03,  5.94698594e-03,  1.69964091e-01], ########### FF tip
 [-7.24441725e-18,  7.26351127e-18,  8.64563969e-02],
 [-3.57711501e-03,  1.17781309e-03,  1.26359816e-01],
 [-3.72205727e-03, -6.71520140e-03,  1.53241475e-01],
 [ 2.67915170e-03, -1.28882510e-02,  1.83932450e-01], ########### MF tip
 [ 1.09969881e-02, -1.42899532e-02,  8.20054540e-02],
 [-4.14662443e-05, -1.75754299e-02,  1.10044929e-01],
 [-8.66059917e-04, -2.09935762e-02,  1.37455233e-01],
 [-1.86921862e-03, -2.06870721e-02,  1.65187556e-01], ########### RF tip
 [ 1.89917087e-02, -3.09123812e-02,  6.56397850e-02],
 [ 9.57255058e-03, -3.28743632e-02,  8.73346018e-02],
 [ 6.72530476e-03, -3.56170190e-02,  1.13019986e-01],
 [ 8.25785921e-03, -3.73950511e-02,  1.50029507e-01]], # PLANE PALM // finger length      

# point 5 9 13
#  [-8.43299064e-18,  1.60713207e-02,  9.37611517e-02],
#  [-7.24441725e-18,  7.26351127e-18,  8.64563969e-02],
#  [ 1.09969881e-02, -1.42899532e-02,  8.20054540e-02],


# [[ 0.00000000e+00,  0.00000000e+00,  0.00000000e+00],
#  [ 1.10027947e-02,  2.88126163e-02,  2.64829028e-02],
#  [ 1.16581651e-02,  5.35062971e-02,  4.22317532e-02],
#  [ 1.35602275e-02,  7.73940999e-02,  6.29212493e-02],
#  [ 3.67179498e-03,  9.28191254e-02,  7.84165107e-02], ########## TH tip
#  [-1.14069116e-18,  2.46888178e-02,  9.54070215e-02],
#  [ 4.42761495e-03,  2.08420735e-02,  1.28344266e-01],
#  [ 1.17371437e-02,  1.48253634e-02,  1.53314183e-01],
#  [ 3.23542341e-02,  7.74580038e-03,  1.68764794e-01], ########### FF tip
#  [-1.88757735e-18, -6.65743773e-19,  9.76461036e-02],
#  [ 9.93655261e-03, -3.41449962e-03,  1.37446354e-01],
#  [ 2.34337502e-02, -9.49951572e-03,  1.57849032e-01],
#  [ 3.43898667e-02, -1.31679144e-02,  1.83883133e-01], ########### MF tip
#  [ 1.04410478e-02, -1.92352783e-02,  9.16363024e-02],
#  [ 2.06843788e-02, -2.52302680e-02,  1.23833339e-01],
#  [ 3.04796837e-02, -2.45557938e-02,  1.44218868e-01],
#  [ 4.23238400e-02, -2.69659540e-02,  1.68357115e-01], ########### RF tip
#  [ 1.87042301e-02, -3.66671067e-02,  7.38425669e-02],
#  [ 2.12948752e-02, -4.10989759e-02,  1.00620753e-01],
#  [ 2.92816694e-02, -4.07409705e-02,  1.21173078e-01],
#  [ 4.03247854e-02, -3.98209271e-02,  1.39846611e-01]], # thumb to most right  
# idx 1
#  outward                 right                  up
[[ 0.00000000e+00,  0.00000000e+00,  0.00000000e+00],
 [ 1.10027947e-02,  2.88126163e-02,  2.64829028e-02],
 [ 1.16581651e-02,  5.35062971e-02,  4.22317532e-02],
 [ 1.35602275e-02,  7.73940999e-02,  6.29212493e-02],
 [ 3.67179498e-03,  9.28191254e-02,  7.84165107e-02], ########## TH tip
 [-1.14069116e-18,  2.46888178e-02,  9.54070215e-02],
 [ 4.42761495e-03,  2.08420735e-02,  1.28344266e-01],
 [ 1.17371437e-02,  1.48253634e-02,  1.53314183e-01],
 [ 3.23542341e-02,  7.74580038e-03,  1.68764794e-01], ########### FF tip
 [-1.88757735e-18, -6.65743773e-19,  9.76461036e-02],
 [ 9.93655261e-03, -3.41449962e-03,  1.37446354e-01],
 [ 2.34337502e-02, -9.49951572e-03,  1.57849032e-01],
 [ 3.43898667e-02, -1.31679144e-02,  1.83883133e-01], ########### MF tip
 [ 1.04410478e-02, -1.92352783e-02,  9.16363024e-02],
 [ 2.06843788e-02, -2.52302680e-02,  1.23833339e-01],
 [ 3.04796837e-02, -2.45557938e-02,  1.44218868e-01],
 [ 4.23238400e-02, -2.69659540e-02,  1.68357115e-01], ########### RF tip
 [ 1.87042301e-02, -3.66671067e-02,  7.38425669e-02],
 [ 2.12948752e-02, -4.10989759e-02,  1.00620753e-01],
 [ 2.92816694e-02, -4.07409705e-02,  1.21173078e-01],
 [ 4.03247854e-02, -3.98209271e-02,  1.59846611e-01]], # thumb to most right  // finger length

# point 5 9 13
#  [-8.43299064e-18,  1.60713207e-02,  9.37611517e-02],
#  [-7.24441725e-18,  7.26351127e-18,  8.64563969e-02],
#  [ 1.09969881e-02, -1.42899532e-02,  8.20054540e-02], 
# point 5 9 13
# [-1.14069116e-18,  2.46888178e-02,  9.54070215e-02],
# [-1.88757735e-18, -6.65743773e-19,  9.76461036e-02],
# [ 1.04410478e-02, -1.92352783e-02,  9.16363024e-02],
# idx 2
#  outward                 right                  up
[[ 0.00000000e+00,  0.00000000e+00,  0.00000000e+00],
 [ 1.07954296e-02,  2.46208749e-02,  2.75980572e-02],
 [ 4.32578568e-02,  2.23385574e-02,  4.58428928e-02],
 [ 7.51346706e-02,  2.18093332e-02,  6.69960946e-02],
 [ 9.51346706e-02,  2.28093332e-02,  8.21369833e-02], ########## TH tip // 3D position not accurate
 [ 2.10652172e-18,  2.23678984e-02,  9.93684723e-02],
 [-1.04412463e-04,  1.83139336e-02,  1.30278738e-01],
 [-4.52610680e-03,  1.59736241e-02,  1.54472739e-01],
 [ 2.61340700e-03,  6.38957371e-04,  1.79070819e-01], ########### FF tip
 [ 2.24504490e-18, -6.07575637e-19,  9.96481490e-02],
 [ 3.64428174e-03, -5.83024123e-03,  1.37979301e-01],
 [ 1.94937814e-04, -1.31418979e-02,  1.62203018e-01],
 [-1.58118493e-04, -1.87365750e-02,  1.92037258e-01], ########### MF tip
 [ 9.06661543e-03, -2.37465767e-02,  9.27967946e-02],
 [ 1.08244364e-02, -2.76836946e-02,  1.24542433e-01],
 [ 1.17271708e-02, -3.33304221e-02,  1.49534948e-01],
 [ 1.22219394e-02, -3.63486262e-02,  1.78641718e-01], ########### RF tip
 [ 1.79395118e-02, -4.04250869e-02,  7.40844843e-02],
 [ 1.81503196e-02, -4.54904160e-02,  9.81976402e-02],
 [ 2.08192215e-02, -4.85238203e-02,  1.20023575e-01],
 [ 2.51870996e-02, -5.63390364e-02,  1.43363305e-01]],# thumb up 
# idx 3
#  outward                 right                  up
[[ 0.00000000e+00,  0.00000000e+00,  0.00000000e+00],
 [ 8.56909398e-03,  3.10891755e-02,  2.33141336e-02],
 [ 1.99719535e-02,  4.87738257e-02,  4.55073014e-02],
 [ 3.27821107e-02,  5.95907559e-02,  7.11176149e-02],
 [ 3.47608100e-02,  6.54578106e-02,  9.65228115e-02], ########## TH tip
 [ 0.65880788e-18,  3.08961991e-02,  9.53493363e-02],
 [ 4.56821297e-02,  3.07788779e-02,  0.90996237e-01],
 [ 6.46993478e-02,  3.30197900e-02,  0.90840888e-01],
 [ 9.51762063e-02,  3.24594307e-02,  0.90545152e-01], ########### FF tip
 [-5.44673246e-18,  1.59768236e-19,  9.98857006e-02],
 [ 1.31498212e-02,  6.64186225e-03,  1.44055442e-01],
 [ 2.79333803e-02,  9.27781329e-03,  1.69659567e-01],
 [ 5.01246713e-02,  1.26218537e-02,  1.97551172e-01], ########### MF tip
 [ 1.38946397e-02, -1.80755199e-02,  9.62000337e-02],
 [ 2.54600831e-02, -1.92940961e-02,  1.29873342e-01],
 [ 4.04888651e-02, -1.70745932e-02,  1.51594220e-01],
 [ 6.18397254e-02, -1.37798002e-02,  1.70921842e-01], ########### RF tip
 [ 2.17112210e-02, -3.35064306e-02,  8.03866143e-02],
 [ 2.72873600e-02, -3.95556480e-02,  1.03309471e-01],
 [ 3.88760160e-02, -4.27796167e-02,  1.25510084e-01],
 [ 5.38877940e-02, -4.19446287e-02,  1.37698653e-01]], # FF up
# idx 4
#  outward                 right                  up
[[ 0.00000000e+00,  0.00000000e+00,  0.00000000e+00],
 [ 8.72474563e-03,  3.02607973e-02,  2.16687863e-02],
 [ 3.82156100e-03,  5.20602780e-02,  5.01196280e-02],
 [-5.07844839e-03,  7.13711611e-02,  8.58584071e-02],
 [-1.94938237e-02,  8.17157423e-02,  1.19152603e-01], ########## TH tip
 [ 4.10730412e-18,  2.65170721e-02,  1.03932932e-01],
 [ 2.05679190e-02,  2.19720429e-02,  1.20435715e-01],
 [ 2.86876325e-02,  2.25085091e-02,  1.15526123e-01], 
 [ 3.42608511e-02,  1.84826729e-02,  8.74751864e-02], ########### FF tip
 [-2.56922298e-19,  8.18523754e-18,  1.10773385e-01],
 [ 2.24691037e-02, -3.15225730e-03,  1.43461622e-01],
 [ 3.95441693e-02, -6.83380462e-03,  1.53633884e-01],
 [ 6.04747760e-02, -3.58998721e-03,  1.63720001e-01], ########### MF tip
 [ 1.09198022e-02, -2.09859166e-02,  1.04772862e-01],
 [ 2.36760036e-02, -2.76028058e-02,  1.36334333e-01],
 [ 3.71512259e-02, -2.96785563e-02,  1.56472057e-01],
 [ 5.13095536e-02, -3.27056647e-02,  1.75852211e-01], ########### RF tip
 [ 1.61555296e-02, -3.20365469e-02,  8.97495580e-02],
 [ 2.20418066e-02, -4.19282404e-02,  1.13204310e-01],
 [ 3.28537586e-02, -4.88573039e-02,  1.34366922e-01],
 [ 4.41087162e-02, -5.43333578e-02,  1.45514111e-01]], #  PLANE PALM, Thumb Right, Thumb Up, FF up, FF curve
# idx 5
#  outward                 right                  up
[[ 0.00000000e+00,  0.00000000e+00,  0.00000000e+00],
 [ 8.82060360e-03,  3.24181407e-02,  2.41063587e-02],
 [ 2.08743753e-02,  5.01768712e-02,  4.87614616e-02],
 [ 3.45488737e-02,  5.51225596e-02,  7.66081666e-02],
 [ 3.88610612e-02,  5.11842471e-02,  1.06253029e-01], ########## TH tip
 [ 1.32491073e-17,  2.88203436e-02,  1.03087228e-01],
 [ 1.45656892e-02,  3.57710264e-02,  1.31980289e-01],
 [ 2.96084300e-02,  3.94652660e-02,  1.51354541e-01],
 [ 6.27823551e-02,  4.79755464e-02,  1.63717026e-01], ########### FF tip
 [ 2.26547275e-18,  1.23072993e-18,  1.06612766e-01],
 [ 3.36421068e-02,  5.73152573e-03,  1.28448312e-01],
 [ 6.46277069e-02,  9.75340967e-03,  1.18140969e-01],
 [ 9.07774532e-02,  1.57839964e-02,  9.93738493e-02], ########### MF tip
 [ 1.45594309e-02, -1.92013225e-02,  9.98674169e-02],
 [ 3.76085282e-02, -1.75949841e-02,  1.25598949e-01],
 [ 6.28712945e-02, -1.20028116e-02,  1.39326879e-01],
 [ 9.31976925e-02, -8.42639851e-03,  1.50542478e-01], ########### RF tip
 [ 2.34539411e-02, -3.52694321e-02,  8.09027527e-02],
 [ 3.42073231e-02, -3.48223859e-02,  1.05732457e-01],
 [ 5.10226030e-02, -3.22495437e-02,  1.27105541e-01],
 [ 6.91995443e-02, -2.75710380e-02,  1.36782148e-01]], # PLANE PALM, Thumb Right, Thumb Up, FF up, FF curve, MF up
# idx 6
#  outward                 right                  up
[[ 0.00000000e+00,  0.00000000e+00,  0.00000000e+00],
 [ 1.16996504e-02,  3.07625353e-02,  2.28876909e-02],
 [ 8.34222553e-03,  5.24027589e-02,  4.61911643e-02],
 [ 1.83460701e-02,  6.84946087e-02,  7.11487227e-02],
 [ 1.63680824e-02,  6.34358556e-02,  9.39484374e-02], ########## TH tip
 [ 6.92938660e-18,  2.44186327e-02,  9.46389300e-02],
 [-2.31821470e-03,  2.98894807e-02,  1.22379528e-01],
 [-3.34259918e-03,  2.75375820e-02,  1.44366010e-01],
 [ 2.15706789e-02,  2.95378592e-02,  1.70426046e-01], ########### FF tip
 [ 9.74099201e-18, -5.37848344e-21,  9.65637445e-02],
 [ 2.75880165e-02,  6.42309167e-04,  1.27329574e-01],
 [ 5.20904732e-02,  6.37055628e-03,  1.06755485e-01],
 [ 5.11167242e-02,  8.81830019e-03,  8.51980807e-02], ########### MF tip
 [ 9.76430548e-03, -1.98159299e-02,  9.67058777e-02],
 [ 3.18468552e-02, -2.30657171e-02,  1.20644878e-01],
 [ 5.29138313e-02, -2.79047292e-02,  1.35721962e-01],
 [ 6.64342972e-02, -3.59587885e-02,  1.55789637e-01], ########### RF tip
 [ 1.91156719e-02, -3.40045439e-02,  7.87341808e-02],
 [ 1.65701774e-02, -4.27668363e-02,  1.00244582e-01],
 [ 1.84368659e-02, -4.70311821e-02,  1.25409568e-01],
 [ 2.26167939e-02, -5.40870894e-02,  1.42163288e-01]], # PLANE PALM, Thumb Right, Thumb Up, FF up, FF curve, MF up, MF curve
# idx 7
#  outward                 right                  up
[[ 0.00000000e+00,  0.00000000e+00,  0.00000000e+00],
 [ 1.33718699e-02,  3.21317628e-02,  3.11250785e-02],
 [ 1.68310255e-02,  5.17790425e-02,  5.60224871e-02],
 [ 3.16384197e-02,  6.62976432e-02,  8.33113383e-02],
 [ 3.72760143e-02,  6.50016409e-02,  1.05993491e-01], ########## TH tip
 [ 4.66402909e-18,  2.46689523e-02,  1.07690366e-01],
 [ 1.72740606e-04,  2.91909974e-02,  1.34817696e-01],
 [ 1.81718325e-03,  2.91787907e-02,  1.54533401e-01],
 [ 2.32326125e-02,  3.07288783e-02,  1.76951595e-01], ########### FF tip
 [ 4.23280841e-18,  4.06244173e-19,  1.04391396e-01],
 [ 6.56039847e-03, -1.28433340e-03,  1.42295277e-01],
 [ 2.44442228e-02, -4.90021903e-03,  1.61677821e-01],
 [ 3.74557666e-02, -4.67866788e-03,  1.88056253e-01], ########### MF tip
 [ 9.19172696e-03, -1.78428224e-02,  9.86265712e-02],
 [ 3.51748535e-02, -1.58937704e-02,  1.16533235e-01],
 [ 5.58352605e-02, -9.89624450e-03,  1.03409602e-01],
 [ 6.85618529e-02, -3.56223764e-03,  9.25151747e-02], ########### RF tip
 [ 2.01629087e-02, -3.06128927e-02,  7.94752479e-02],
 [ 2.45774390e-02, -3.55795139e-02,  1.03841219e-01],
 [ 3.14374517e-02, -3.60652617e-02,  1.29819419e-01],
 [ 4.80631846e-02, -3.18618045e-02,  1.50366597e-01]], # PLANE PALM, Thumb Right, Thumb Up, FF up, FF curve, MF up, MF curve, RF up
# idx 8
#  outward                 right                  up
[[ 0.00000000e+00,  0.00000000e+00,  0.00000000e+00],
 [ 1.40195534e-02,  3.14278368e-02,  3.19671555e-02],
 [ 1.63870713e-02,  5.09522161e-02,  5.74249112e-02],
 [ 3.06827755e-02,  6.44921834e-02,  8.44980343e-02],
 [ 3.72882269e-02,  6.01824943e-02,  1.06735264e-01], ########## TH tip
 [ 3.27838059e-18,  2.41716521e-02,  1.09578237e-01],
 [ 6.78246579e-04,  2.78299454e-02,  1.37083050e-01],
 [ 3.49020317e-04,  2.83121756e-02,  1.55476199e-01],
 [ 2.06334044e-02,  2.83661448e-02,  1.78163614e-01], ########### FF tip
 [ 4.98887103e-20,  7.19784975e-19,  1.05428387e-01],
 [ 7.17197027e-03, -1.72117458e-03,  1.42652450e-01],
 [ 2.47371351e-02, -5.16853216e-03,  1.62333506e-01],
 [ 3.72372433e-02, -4.60214904e-03,  1.88055346e-01], ########### MF tip
 [ 9.12068705e-03, -1.84443467e-02,  9.89008053e-02],
 [ 3.56428273e-02, -1.64844307e-02,  1.15874173e-01],
 [ 5.66923031e-02, -1.08481814e-02,  1.01674118e-01],
 [ 6.75558689e-02, -3.32229574e-03,  8.91313422e-02], ########### RF tip
 [ 1.95226309e-02, -3.09745255e-02,  7.95326997e-02],
 [ 2.39329151e-02, -3.68365847e-02,  1.03705528e-01],
 [ 2.98856867e-02, -3.78285299e-02,  1.29310486e-01],
 [ 4.55881141e-02, -3.51662149e-02,  1.48511695e-01]], # PLANE PALM, Thumb Right, Thumb Up, FF up, FF curve, MF up, MF curve, RF up, RF curve
# idx 9
#  outward                 right                  up
[[ 0.00000000e+00,  0.00000000e+00,  0.00000000e+00],
 [ 1.23390711e-02,  2.91365239e-02,  2.98703134e-02],
 [ 1.80000793e-02,  4.96994897e-02,  5.47214220e-02],
 [ 3.38937229e-02,  6.39663476e-02,  8.60167884e-02],
 [ 3.79396186e-02,  6.64615420e-02,  1.15628365e-01], ########## TH tip
 [-4.71953466e-18,  2.29790463e-02,  1.02003182e-01],
 [ 3.80438098e-03,  2.83027573e-02,  1.32155958e-01],
 [ 5.26721231e-03,  3.08778299e-02,  1.54633604e-01],
 [ 2.39383204e-02,  3.10756197e-02,  1.79464631e-01], ########### FF tip
 [-6.28288379e-18, -5.30787708e-19,  1.04370151e-01],
 [-1.58434554e-03, -6.76082235e-03,  1.40993391e-01],
 [ 1.36048048e-02, -1.24549443e-02,  1.65615852e-01],
 [ 2.37646861e-02, -1.54180714e-02,  1.93614764e-01], ########### MF tip
 [ 9.05346758e-03, -1.70405837e-02,  9.94171152e-02],
 [ 1.31469605e-02, -2.51377707e-02,  1.31772289e-01],
 [ 2.53504957e-02, -2.92669063e-02,  1.57472037e-01],
 [ 3.92140513e-02, -3.21753270e-02,  1.84153305e-01], ########### RF tip
 [ 1.85003877e-02, -2.95420705e-02,  8.27074732e-02],
 [ 2.89171644e-02, -3.50549130e-02,  9.78910615e-02],
 [ 4.86885069e-02, -2.96919915e-02,  1.06650658e-01],
 [ 6.81414884e-02, -2.36737880e-02,  1.04752120e-01]], # PLANE PALM, Thumb Right, Thumb Up, FF up, FF curve, MF up, MF curve, RF up, RF curve, LF up
# idx 10
#  outward                 right                  up
[[ 0.00000000e+00,  0.00000000e+00,  0.00000000e+00],
 [ 9.68644616e-03,  3.08966899e-02,  2.65336263e-02],
 [ 2.01797751e-02,  5.34755007e-02,  5.51907080e-02],
 [ 3.13309177e-02,  6.67301553e-02,  8.47218284e-02],
 [ 3.57701007e-02,  6.92072984e-02,  1.11787794e-01], ########## TH tip
 [ 1.53839629e-18,  2.44465365e-02,  1.03781548e-01],
 [ 3.03432125e-03,  2.89530155e-02,  1.34134564e-01],
 [ 3.28001270e-03,  2.94710805e-02,  1.56602121e-01],
 [ 2.14095876e-02,  2.90187644e-02,  1.82739435e-01], ########### FF tip
 [ 2.21918744e-18, -6.64149156e-19,  1.02961324e-01],
 [-2.69051271e-03, -1.75501663e-03,  1.43161593e-01],
 [ 5.54725525e-03, -4.07697135e-03,  1.69571118e-01],
 [ 1.39770372e-02, -5.58020231e-03,  1.98949042e-01], ########### MF tip
 [ 9.77922064e-03, -1.81186443e-02,  9.70870035e-02],
 [ 2.30172023e-02, -2.32155483e-02,  1.26103909e-01],
 [ 4.08496643e-02, -2.55797240e-02,  1.46407324e-01],
 [ 6.04669508e-02, -2.79440072e-02,  1.68602788e-01], ########### RF tip
 [ 1.93839334e-02, -3.07073469e-02,  7.82859814e-02],
 [ 3.46341203e-02, -3.23442420e-02,  8.98937561e-02],
 [ 5.24969722e-02, -2.39379923e-02,  8.84395567e-02],
 [ 6.37279145e-02, -1.66648127e-02,  7.80278039e-02]], # PLANE PALM, Thumb Right, Thumb Up, FF up, FF curve, MF up, MF curve, RF up, RF curve, LF up, LF curve

# idx 11
#  outward                 right                  up
[[ 0.00000000e+00,  0.00000000e+00,  0.00000000e+00],
 [ 5.46539952e-03,  2.64457567e-02,  1.97150170e-02],
 [ 1.46824036e-02,  3.72654269e-02,  3.51877542e-02],
 [ 3.68740521e-02,  3.97890198e-02,  5.70721761e-02],
 [ 5.08697077e-02,  2.50867584e-02,  7.15719643e-02], ########## TH tip
 [ 6.55279825e-18,  1.68974405e-02,  7.96809847e-02],
 [ 1.86307686e-02,  1.74029824e-02,  9.66392772e-02],
 [ 3.88760235e-02,  2.08207083e-02,  9.28280754e-02],
 [ 5.71299786e-02,  2.81139971e-02,  8.26795507e-02], ########### FF tip
 [-7.88133897e-19,  4.43226438e-18,  7.86368802e-02],
 [-1.14207911e-03, -1.50080228e-02,  1.08403072e-01],
 [ 2.26151385e-02, -1.74163950e-02,  1.23679000e-01],
 [ 4.19457105e-02, -2.20379390e-02,  1.34063594e-01], ########### MF tip
 [ 2.70266846e-03, -1.04705427e-02,  7.79556189e-02],
 [ 1.04966466e-02, -2.49144909e-02,  9.89005223e-02],
 [ 2.77483483e-02, -3.43575622e-02,  1.12952125e-01],
 [ 4.09791409e-02, -4.19075427e-02,  1.22649001e-01], ########### RF tip
 [ 1.27364895e-02, -1.84183781e-02,  6.62182174e-02],
 [ 1.48985883e-02, -3.25317716e-02,  8.53944918e-02],
 [ 2.53084620e-02, -4.68081760e-02,  1.01745542e-01],
 [ 4.02906871e-02, -5.29415272e-02,  1.15594645e-01]],


]
        self.gesture_name = [ 'PLANE PALM', 'Thumb Right', 'Thumb Up', 'FF up', 'FF curve', 'MF up', 'MF curve', 'RF up', 'RF curve', 'LF up', 'LF curve']

        self.test_pos = np.array(self.test_pos)
        self.detector = SingleHandDetector(hand_type="Right", selfie=False)
        
        self.rgb_sub = message_filters.Subscriber("/rgb/image_raw", Image)
        self.depth_sub = message_filters.Subscriber("/depth_to_rgb/image_raw", Image)

        #self.ts = message_filters.TimeSynchronizer([self.rgb_sub, self.depth_sub], 10)
        self.ts = message_filters.ApproximateTimeSynchronizer([self.rgb_sub, self.depth_sub], 10, 1, allow_headerless=True)
        self.ts.registerCallback(self.callback)

        self.joint_pub = rospy.Publisher('/qpos', Float32MultiArray, queue_size=1000)
        self.pub = rospy.Publisher('chatter', String, queue_size=1000)
        self.annotated_img_pub = rospy.Publisher('/annotated_img', Image, queue_size=100)

    def run(self):
        rospy.spin()  

    def callback(self, bgra_msg, depth_msg):

        self.count += 1
        # start = time.time()
        bgra = bridge.imgmsg_to_cv2(bgra_msg)
        bgr = np.array(bgra[:,:,0:3])
        rgb = cv2.cvtColor(bgr, cv2.COLOR_BGR2RGB)
        depth = bridge.imgmsg_to_cv2(depth_msg)

        num_box, joint_pos, keypoint_2d, mediapipe_wrist_rot, annotated_img = self.detector.detect(rgb)
        if joint_pos is None:
           print("no hands found")
           return

        retargeting_type = self.retargeting.optimizer.retargeting_type
        
        img_msg = bridge.cv2_to_imgmsg(annotated_img, encoding="rgb8")
        img_msg.header = bgra_msg.header
        self.annotated_img_pub.publish(img_msg)
        indices = self.retargeting.optimizer.target_link_human_indices

        idx = self.count//120
        idx = idx% len(self.test_pos)
        #idx = 0
        # 0, 1, 3, 4 ok
        # 2 fail
        joint_pos = self.test_pos[idx]
        # for frankmocap, new_order not correct
        #new_order = [0,    13, 14, 15, 20,      1, 2, 3, 16,    4, 5, 6, 17,   10, 11, 12, 19, 7, 8, 9, 18]
        #joint_pos = self.test_pos[idx][new_order][:]

        if retargeting_type == "POSITION":
            indices = indices
            ref_value = joint_pos[indices, :]
        else:
            origin_indices = indices[0, :]
            task_indices = indices[1, :]
            ref_value = joint_pos[task_indices, :] - joint_pos[origin_indices, :]

        qpos = self.retargeting.retarget(ref_value)
        for i in range(24):
            print("joint ", i, " : ", qpos[i])
        print("gesture: ", self.gesture_name[idx])

        print("ref_value: ", ref_value.shape)
        if retargeting_type == "DEXPILOT":
            for i in range(5):
                print("3D pos of finger ", i, " : ", ref_value[i+10])
        qpos_msg = Float32MultiArray()
        qpos_msg.data = qpos
        self.joint_pub.publish(qpos_msg)
	
        # print("qpos found")
        # print("qpos: \n", qpos)        
        # end = time.time()
        # print( (end - start)*1000.0)
        # data.append(qpos)


def main(
    robot_name: RobotName, video_path: str, output_path: str, retargeting_type: RetargetingType, hand_type: HandType
):
    """
    Detects the human hand pose from a video and translates the human pose trajectory into a robot pose trajectory.

    Args:
        robot_name: The identifier for the robot. This should match one of the default supported robots.
        video_path: The file path for the input video in .mp4 format.
        output_path: The file path for the output data in .pickle format.
        retargeting_type: The type of retargeting, each type corresponds to a different retargeting algorithm.
        hand_type: Specifies which hand is being tracked, either left or right.
            Please note that retargeting is specific to the same type of hand: a left robot hand can only be retargeted
            to another left robot hand, and the same applies for the right hand.
    """

    config_path = get_config_path(robot_name, retargeting_type, hand_type)
    robot_dir = Path(__file__).parent.parent / "assets" / "robots"
    RetargetingConfig.set_default_urdf_dir(str(robot_dir))
    retargeting = RetargetingConfig.load_from_file(config_path).build()
    rospy.init_node("mocap_node")
    retarget_node = retarget(retargeting, video_path, output_path, str(config_path))
    retarget_node.run()


if __name__ == "__main__":
    tyro.cli(main)
